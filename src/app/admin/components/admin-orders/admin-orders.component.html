<app-admin-navbar></app-admin-navbar>
<div class="container">
  <h2 class="mb-4">Customer Orders</h2>

  <div *ngIf="ordersList.length === 0" class="alert alert-info">
    No orders found.
  </div>

  <ng-container *ngFor="let order of ordersList; let i = index">
    <div class="mb-4 order-card card" [ngClass]="{ 'cancelled-order': isCancelled(order),
     'new-order-blink': order.status === 'Waiting for CC to accept your order'}">

      <div class="card-content">
        <div class="left-content">
          <small class="fw-bold">Customer Name: {{ order.user?.fullName || 'Unknown' }}</small>
          <br>
          <small class="text-success">Order #{{ order.id }}</small>
          <br>
          <small>Order Total: <b>{{ order.total | currency: 'INR' }}</b></small>
          <br>
          <small class="text-muted">Ordered on: {{ order.createdAt?.toDate() | date: 'medium' }}</small>
          <br>

          <!-- Toggle Details -->
          <button class="btn btn-sm btn-primary mt-4"
                  type="button"
                  (click)="toggleShowMore(order.id)"
                  [attr.aria-expanded]="expandedOrders[order.id] || false"
                  [attr.aria-controls]="'collapse' + order.id">
          <span *ngIf="expandedOrders[order.id]; else showMore">
            <i class="fa-solid fa-eye-slash ms-1"></i> Hide Order Details
          </span>
            <ng-template #showMore>
              <i class="fa-solid fa-eye ms-1"></i> Show Order Details
            </ng-template>
          </button>
        </div>

        <div class="right-content">
          <div>
                     <span class="badge bg-danger mt-2 mb-2 p-2"
                           *ngIf="isOrderClosed(order.status)">
                          Order Closed
                    </span>
            <!-- CANCELLATION BADGE -->
            <span *ngIf="isCancelled(order)" class="badge bg-danger p-2 mt-2">Order {{ order.status }}</span>
          </div>

          <div>
            <label class="fw-bold mt-3">Order Status</label>

            <!-- STATUS SELECT - Disabled if cancelled -->
            <select
              class="form-select w-100 mt-3 mb-2 p-2"
              style="width: 320px"
              [(ngModel)]="order.status"
              [ngModelOptions]="{standalone: true}"
              (ngModelChange)="changeStatus(order, $event)"
              [disabled]="isCancelled(order)"
            >
              <option *ngFor="let status of orderStatuses" [ngValue]="status">
                {{ status }}
              </option>
            </select>
          </div>

          <!-- INVOICE BUTTONS - hidden if cancelled -->
          <div class="button-groups">
            <button class="btn btn-sm btn-primary mt-3"
                    type="button"
                    (click)="downloadInvoicePdf(order)"
                    *ngIf="!isCancelled(order)">
              <i class="fa-solid fa-file-arrow-down"></i> Download Invoice
            </button>

            <button class="btn btn-sm btn-primary mt-3"
                    type="button"
                    (click)="printOrderInvoice(order)"
                    *ngIf="!isCancelled(order)">
              <i class="fa-solid fa-print"></i> Print Invoice
            </button>
          </div>
        </div>
      </div>

      <!-- Collapse section with unique ID -->
      <div [id]="'collapse' + order.id"
           class="collapse"
           [class.show]="expandedOrders[order.id]">
        <div class="card-body">
          <ul class="list-group-m" *ngFor="let item of order.items">
            <li class="list-group-item text-muted">
              <p>{{ item.name }} X {{ item.quantity }}</p>
              <p>{{ item.quantity }} N x {{ item.price }} =
                {{ item.price * item.quantity | currency: 'INR' }}
              </p>
            </li>
            <hr>
          </ul>
        </div>
      </div>
    </div>
  </ng-container>
</div>


